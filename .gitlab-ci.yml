image: node:latest

stages:
    - build
    - deploy

# GitLab Pages deployment
pages:
    image: docker-registry.wikimedia.org/php7.4-cli:latest
    stage: build
    script:
        - php build.php > public/redwarn.js
    artifacts:
        paths:
            # GitLab pages
            - public
    rules:
        -   if: $CI_PROJECT_PATH != "repos/10nm/redwarn-web"
            when: never
        -   if: $CI_COMMIT_REF_NAME == "master"
        -   if: $CI_COMMIT_REF_NAME =~ /^c[id]-.*$/

################################################################################
# ENGLISH WIKIPEDIA DEPLOYMENT
################################################################################
# The following takes into consideration Wikipedia policy. Edits to any CI
# process below this section MUST be reviewed by a RedWarn Core Team member
# before merging.

deploy_start:
    stage: deploy
    environment:
        name: production
        url: https://en.wikipedia.org/wiki/User:RedWarn/.js
    when: manual
    rules:
        -   if: $CI_PROJECT_PATH != "repos/10nm/redwarn-web"
            when: never
        -   if: $CI_COMMIT_REF_NAME == "master"
            changes:
                - .gitlab-ci.yml
                - build.php
                - src/**/*
                - .gitlab/ci_scripts/**/*
        -   if: $CI_COMMIT_REF_NAME =~ /^c[id]-.*$/
            changes:
                - .gitlab-ci.yml
                - build.php
                - src/**/*
                - .gitlab/ci_scripts/**/*
            variables:
                DRY_RUN: 1
    allow_failure: false
    script:
        - cd .gitlab/ci_scripts
        - npm ci
        - node enwiki/deploy.js
